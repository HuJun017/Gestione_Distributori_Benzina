<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Monitoraggio Distributori Iperstaroil</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
#map { height: 75vh; border-radius: 0.5rem; }
.card { margin-bottom: 1rem; position: relative; }
.close-btn {
  position:absolute; top:0.5rem; right:0.5rem;
  background:#e74c3c; color:white; border:none; border-radius:0.25rem; padding:0.1rem 0.4rem; font-size:0.8rem;
}
.close-btn:hover { background:#c0392b; }
</style>
</head>
<body>
<header class="bg-dark text-white p-3 mb-3">
  <div class="container">
    <h2 class="mb-0">Monitoraggio Distributori Iperstaroil</h2>
  </div>
</header>

<main class="container">
  <div class="row g-3">
    <!-- Colonna sinistra -->
    <div class="col-md-4">
      <!-- Elenco distributori -->
      <div class="card p-3">
        <h5>Elenco distributori (tutti)</h5>
        <button id="btn-list-all" class="btn btn-primary btn-sm mb-2">Mostra elenco</button>
        <div id="list-all"></div>
      </div>

      <!-- Ricerca per provincia -->
      <div class="card p-3">
        <h5>Ricerca per provincia</h5>
        <input id="prov-input" type="text" class="form-control form-control-sm mb-2" placeholder="Es. Milano">
        <button id="btn-prov" class="btn btn-primary btn-sm mb-2">Cerca</button>
        <div id="prov-result"></div>
      </div>

      <!-- Ricerca per ID -->
      <div class="card p-3">
        <h5>Ricerca per ID</h5>
        <input id="id-input" type="number" min="1" class="form-control form-control-sm mb-2">
        <button id="btn-id" class="btn btn-primary btn-sm mb-2">Cerca</button>
        <div id="id-result"></div>
      </div>

      <!-- Cambio prezzo -->
      <div class="card p-3">
        <h5>Cambio prezzo per provincia</h5>
        <input id="prov-price" type="text" class="form-control form-control-sm mb-2" placeholder="Es. Milano">
        <select id="tipo-price" class="form-select form-select-sm mb-2">
          <option value="benzina">Benzina</option>
          <option value="diesel">Diesel</option>
        </select>
        <input id="new-price" type="number" step="0.01" class="form-control form-control-sm mb-2" placeholder="Nuovo prezzo (€)">
        <button id="btn-change-price" class="btn btn-primary btn-sm mb-2">Aggiorna prezzi</button>
        <div id="change-result"></div>
      </div>

      <!-- Eroga carburante -->
      <div class="card p-3">
        <h5>Eroga carburante</h5>
        <input id="id-eroga" type="number" min="1" class="form-control form-control-sm mb-2" placeholder="ID distributore">
        <select id="tipo-eroga" class="form-select form-select-sm mb-2">
          <option value="benzina">Benzina</option>
          <option value="diesel">Diesel</option>
        </select>
        <input id="litri-eroga" type="number" step="0.01" class="form-control form-control-sm mb-2" placeholder="Litri da erogare">
        <button id="btn-eroga" class="btn btn-primary btn-sm mb-2">Eroga</button>
        <div id="eroga-result"></div>
      </div>
    </div>

    <!-- Colonna destra (mappa) -->
    <div class="col-md-8">
      <div class="card p-3">
        <h5>Mappa distributori</h5>
        <div id="map"></div>
      </div>
    </div>
  </div>
</main>

<!-- JS Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- JS Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Inizializzazione mappa
const map = L.map('map').setView([41.9, 12.5], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
const markers = L.layerGroup().addTo(map);

// Aggiorna mappa
function aggiornaMappa(data) {
    markers.clearLayers();
    data.forEach(d => {
        const [lat, lon] = d.coordinate;
        const popup = `<b>${d.nome} (ID ${d.id})</b><br/>
                       Provincia: ${d.provincia}<br/>
                       Benzina: ${d.benzina_disponibile} L (€${d.prezzo_benzina})<br/>
                       Diesel: ${d.diesel_disponibile} L (€${d.prezzo_diesel})`;
        L.marker([lat, lon]).addTo(markers).bindPopup(popup);
    });
    if (data.length) {
        const coords = data.map(d => d.coordinate);
        map.fitBounds(L.latLngBounds(coords).pad(0.2));
    }
}

// Genera elenco distributori con card Bootstrap
function generaElenco(data, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    (Array.isArray(data) ? data : [data]).forEach(d => {
        const el = document.createElement('div');
        el.className = 'card p-2 position-relative';
        el.innerHTML = `
            <button class="close-btn" onclick="this.parentElement.remove()">✖</button>
            <strong>${d.nome} (ID ${d.id})</strong><br/>
            <b>Provincia:</b> ${d.provincia}<br/>
            <b>Coordinate:</b> ${d.coordinate[0]}, ${d.coordinate[1]}<br/>
            <b>Numero pompe:</b> ${d.numero_pompe}<br/>
            <hr>
            <b>Benzina disponibile:</b> ${d.benzina_disponibile} L — € ${d.prezzo_benzina}<br/>
            <b>Diesel disponibile:</b> ${d.diesel_disponibile} L — € ${d.prezzo_diesel}<br/>
            <hr>
            <b>Litri benzina venduti:</b> ${d.litri_benzina_venduti}<br/>
            <b>Litri diesel venduti:</b> ${d.litri_diesel_venduti}<br/>
            <b>Incasso totale:</b> € ${d.incasso}<br/>
            <hr>
            <label>Tipo carburante</label>
            <select id="tipo-${d.id}" class="form-select form-select-sm mb-1">
                <option value="benzina">Benzina</option>
                <option value="diesel">Diesel</option>
            </select>
            <label>Litri da erogare</label>
            <input type="number" id="litri-${d.id}" min="1" class="form-control form-control-sm mb-1"/>
            <button class="btn btn-success btn-sm" onclick="eroga(${d.id})">Eroga</button>
        `;
        el.addEventListener('click', () => {
            const [lat, lon] = d.coordinate;
            map.flyTo([lat, lon], 17, { duration: 1.5 });
        });
        container.appendChild(el);
    });
}

// Funzione unica erogazione
async function eroga(id) {
    const tipo = document.getElementById(`tipo-${id}`).value;
    const litri = document.getElementById(`litri-${id}`).value;

    if (!litri || litri <= 0) {
        alert("Inserisci una quantità valida di litri");
        return;
    }

    try {
        const url = `/distributori/eroga/${id}?tipo=${encodeURIComponent(tipo)}&litri=${encodeURIComponent(litri)}`;
        const res = await fetch(url, { method: "POST" });
        const data = await res.json();

        if (data.errore) {
            alert(data.errore);
            return;
        }

        generaElenco(data, 'id-result');
        aggiornaMappa([data]);
    } catch (err) {
        console.error(err);
        alert("Errore nella richiesta");
    }
}

// Elenco completo
let elencoVisibile = false;
document.getElementById('btn-list-all').addEventListener('click', async () => {
    const btn = document.getElementById('btn-list-all');
    const containerId = 'list-all';
    if (elencoVisibile) {
        document.getElementById(containerId).innerHTML = "";
        markers.clearLayers();
        btn.innerText = "Mostra elenco";
        elencoVisibile = false;
        return;
    }
    try {
        const res = await fetch('/distributori');
        const data = await res.json();
        generaElenco(data, containerId);
        aggiornaMappa(data);
        btn.innerText = "Nascondi elenco";
        elencoVisibile = true;
    } catch (err) {
        console.error(err);
        alert("Errore nel recupero dati: " + err);
    }
});

// Ricerca per provincia
document.getElementById('btn-prov').addEventListener('click', async () => {
    const prov = document.getElementById('prov-input').value.trim();
    if (!prov) return alert('Inserisci una provincia');
    try {
        const res = await fetch(`/distributori/provincia/${encodeURIComponent(prov)}`);
        const data = await res.json();
        generaElenco(data, 'prov-result');
        aggiornaMappa(data);
    } catch (err) {
        console.error(err);
        alert("Errore nella ricerca per provincia");
    }
});

// Ricerca per ID
document.getElementById('btn-id').addEventListener('click', async () => {
    const id = document.getElementById('id-input').value;
    if (!id) return alert('Inserisci un ID');
    try {
        const res = await fetch(`/distributori/${id}`);
        const data = await res.json();
        generaElenco(data, 'id-result');
        aggiornaMappa(Array.isArray(data) ? data : [data]);
    } catch (err) {
        console.error(err);
        alert("Errore nella ricerca per ID");
    }
});

// Cambio prezzo
document.getElementById('btn-change-price').addEventListener('click', async () => {
    const prov = document.getElementById('prov-price').value.trim();
    const tipo = document.getElementById('tipo-price').value;
    const nuovo = document.getElementById('new-price').value;
    if (!prov || !tipo || !nuovo) return alert('Compila tutti i campi per il cambio prezzo');
    try {
        const url = `/distributori/prezzo/${encodeURIComponent(prov)}?tipo=${encodeURIComponent(tipo)}&nuovo_prezzo=${encodeURIComponent(nuovo)}`;
        const res = await fetch(url, { method: 'POST' });
        const data = await res.json();
        generaElenco(data, 'change-result');
    } catch (err) {
        console.error(err);
        alert("Errore nell'aggiornamento dei prezzi");
    }
});

// Eroga carburante dalla scheda apposita
document.getElementById('btn-eroga').addEventListener('click', async () => {
    const id = document.getElementById('id-eroga').value;
    const tipo = document.getElementById('tipo-eroga').value;
    const litri = document.getElementById('litri-eroga').value;

    if (!id || !tipo || !litri) {
        return alert("Compila tutti i campi per erogare carburante");
    }

    try {
        const url = `/distributori/eroga/${id}?tipo=${encodeURIComponent(tipo)}&litri=${encodeURIComponent(litri)}`;
        const res = await fetch(url, { method: "POST" });
        const data = await res.json();

        if (data.errore) {
            document.getElementById('eroga-result').innerHTML = `<p class="text-danger">${data.errore}</p>`;
        } else {
            generaElenco(data, 'eroga-result');
            aggiornaMappa([data]);
        }
    } catch (err) {
        console.error(err);
        alert("Errore nell'erogazione del carburante");
    }
});
</script>
</body>
</html>
